<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor de Mapas SVG — Inserir, CSV & Gerar</title>
  <style>
    :root{ --bg:#0f1724; --card:#0b1220; --accent:#0ea5a4; --muted:#94a3b8 }
    body{font-family:Inter,Segoe UI,Roboto,Arial; margin:0; min-height:100vh; background:linear-gradient(180deg,#071028 0%, #071b2a 100%); color:#e6eef6; display:flex; align-items:center; justify-content:center; padding:24px}
    .app{width:100%; max-width:1100px}

    header{display:flex; align-items:center; justify-content:space-between; gap:12px}
    h1{font-size:18px; margin:0}
    p.lead{margin:0; font-size:13px; color:var(--muted)}

    .controls{display:flex; gap:12px; margin:18px 0; align-items:center; flex-wrap:wrap}
    .btn{background:var(--accent); color:#042026; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
    .input-file{display:none}

    .viewer-wrap{border-radius:10px; padding:12px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04)}
    .viewer{height:560px; border-radius:8px; background:#071826; display:flex; align-items:center; justify-content:center; overflow:auto; position:relative}
    .viewer .placeholder{color:var(--muted); text-align:center}

    .meta{margin-top:10px; font-size:13px; color:var(--muted); display:flex; gap:12px; align-items:center}
    .dropzone{flex:1; border:2px dashed rgba(255,255,255,0.04); border-radius:8px; padding:18px; display:flex; align-items:center; justify-content:center; gap:12px; cursor:pointer}

    @media (max-width:700px){ .viewer{height:360px} }

    .info-pill{background:rgba(255,255,255,0.03); padding:6px 8px; border-radius:999px}
    .filename{max-width:400px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Editor de Mapas SVG — Inserir & Gerar</h1>
        <p class="lead">Carregue um SVG e um CSV e gere o mapa editado.</p>
      </div>
      <div class="info-pill">Versão inicial</div>
    </header>

    <div class="controls">
      <label class="btn" for="csv-input">Inserir arquivo .csv</label>
      <input id="csv-input" class="input-file" type="file" accept=".csv" />

      <label class="btn" for="file-input">Inserir arquivo .svg</label>
      <input id="file-input" class="input-file" type="file" accept=".svg,image/svg+xml" />

      <button id="generate" class="btn">Gerar mapa</button>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
        <div class="meta">SVG: <span id="filename" class="filename">— nenhum —</span></div>
        <div class="meta">CSV: <span id="csvname" class="filename">— nenhum —</span></div>
      </div>
    </div>

    <div class="viewer-wrap">
      <div id="viewer" class="viewer">
        <div class="placeholder">
          <div style="font-size:14px; font-weight:600; margin-bottom:6px">Nenhum SVG carregado</div>
        </div>
      </div>
    </div>

    <div id="csv-viewer" style="margin-top:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; max-height:250px; overflow:auto; font-size:13px; display:none"></div>

    <div style="margin-top:12px">
      <a id="download-link" style="display:none; color:var(--accent); font-weight:600" download="mapa_editado.svg">Download do mapa editado</a>
    </div>

    <footer style="margin-top:10px; color:var(--muted); font-size:13px">O CSV deve conter colunas: nome_mun, region, value, long-name</footer>
  </div>

  <script>
    const csvInput = document.getElementById('csv-input');
    const csvNameEl = document.getElementById('csvname');
    let csvData = null;

    const fileInput = document.getElementById('file-input');
    const filenameEl = document.getElementById('filename');
    const viewer = document.getElementById('viewer');
    let svgTextGlobal = null;

    function showSVG(svgText, name) {
      viewer.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.innerHTML = svgText.replace(/<script[\s\S]*?<\/script>/gi, '');
      if (!wrapper.querySelector('svg')) {
        viewer.innerHTML = `<div class="placeholder">Arquivo não contém &lt;svg&gt; válido.</div>`;
        filenameEl.textContent = name || '— inválido —';
        return;
      }
      viewer.appendChild(wrapper);
      svgTextGlobal = wrapper.innerHTML;
      filenameEl.textContent = name || '— sem nome —';
    }

    function handleSVGFile(file) {
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.svg') && file.type !== 'image/svg+xml') {
        alert('Selecione um arquivo SVG');
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => showSVG(e.target.result, file.name);
      reader.readAsText(file);
    }

    function renderCSV(text) {
      const csvViewer = document.getElementById('csv-viewer');
      if (!text) return;
      const rows = text.split(/\r?\n/).filter(r => r.trim() !== '');
      csvData = rows.map(r => {
        const [nome_mun, region, value, long_name] = r.split(',');
        return {nome_mun:nome_mun.trim(), region:region.trim(), value:value.trim(), long_name:long_name.trim()};
      });
      csvViewer.innerHTML = '<pre>' + text + '</pre>';
      csvViewer.style.display = 'block';
    }

    csvInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      csvNameEl.textContent = file.name || '— sem nome —';
      const reader = new FileReader();
      reader.onload = ev => renderCSV(ev.target.result);
      reader.readAsText(file);
      csvInput.value = '';
    });

    fileInput.addEventListener('change', e => { handleSVGFile(e.target.files[0]); fileInput.value = ''; });

    document.getElementById('generate').addEventListener('click', () => {
      if (!svgTextGlobal || !csvData) { alert('Carregue o SVG e o CSV antes de gerar.'); return; }
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgTextGlobal, 'image/svg+xml');
      const paths = doc.querySelectorAll('path');
      paths.forEach(p => {
        const label = p.getAttribute('label') || p.getAttribute('inkscape:label');
        const csvRow = csvData.find(r => r.nome_mun === label);
        p.setAttribute('region','0');
        p.setAttribute('value','0');
        p.setAttribute('long-name','None');
        if (csvRow) {
          p.setAttribute('region', csvRow.region);
          p.setAttribute('value', csvRow.value);
          p.setAttribute('long-name', csvRow['long_name']);
        }
      });
      const serializer = new XMLSerializer();
      const svgStr = serializer.serializeToString(doc);
      const blob = new Blob([svgStr], {type:'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      const link = document.getElementById('download-link');
      link.href = url;
      link.style.display = 'inline';
      link.textContent = 'Download do mapa editado';
    });
  </script>
</body>
</html>
